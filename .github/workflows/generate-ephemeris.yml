name: ğŸŒŸ Generate Daily Astronomy Ephemeris

on:
  # âš ï¸ DESACTIVADO - Sin crÃ©ditos de OpenAI
  # Ejecutar diariamente a las 8:00 AM UTC (10:00 AM CEST)
  # schedule:
  #   - cron: "0 8 * * *"

  # Permitir ejecuciÃ³n manual desde GitHub (mantener para cuando tengas crÃ©ditos)
  workflow_dispatch:
    inputs:
      days:
        description: "NÃºmero de dÃ­as a generar (default: 1)"
        required: false
        default: "1"
        type: string
      mode:
        description: "Modo de generaciÃ³n"
        required: false
        default: "tomorrow"
        type: choice
        options:
          - tomorrow
          - week
          - month
          - multiple

jobs:
  generate-ephemeris:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: âœ… Validate environment variables
        run: |
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then
            echo "âŒ NEXT_PUBLIC_SUPABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" ]; then
            echo "âŒ NEXT_PUBLIC_SUPABASE_ANON_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ OPENAI_API_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required environment variables are configured"

      - name: ğŸŒŸ Generate astronomy ephemeris
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸš€ Starting ephemeris generation..."
          echo "ğŸ“… Current date: $(date)"
          echo "ğŸŒ Timezone: UTC"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ github.event.inputs.mode }}"
            DAYS="${{ github.event.inputs.days }}"
            
            case $MODE in
              "tomorrow")
                echo "ï¿½ Manual execution: Generating ephemeris for tomorrow..."
                node generate-ephemeris.mjs tomorrow
                ;;
              "week")
                echo "ğŸ“… Manual execution: Generating ephemeris for the next 7 days..."
                node generate-ephemeris.mjs week
                ;;
              "month")
                echo "ğŸ“… Manual execution: Generating ephemeris for the next 30 days..."
                node generate-ephemeris.mjs month
                ;;
              "multiple")
                echo "ğŸ“… Manual execution: Generating ephemeris for $DAYS days..."
                node generate-ephemeris.mjs multiple $DAYS
                ;;
              *)
                echo "ğŸ“… Manual execution: Default - generating ephemeris for tomorrow..."
                node generate-ephemeris.mjs tomorrow
                ;;
            esac
          else
            echo "â° Scheduled execution: Generating ephemeris for tomorrow..."
            node generate-ephemeris.mjs tomorrow
          fi

      - name: ğŸ“Š Display execution summary
        if: always()
        run: |
          echo "ğŸ“‹ Execution Summary:"
          echo "ğŸ• Execution time: $(date)"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ‘¤ Manually triggered by: ${{ github.actor }}"
            echo "âš™ï¸ Mode: ${{ github.event.inputs.mode }}"
            echo "ğŸ“Š Days: ${{ github.event.inputs.days }}"
          else
            echo "â° Automatically triggered by schedule"
          fi

      - name: âœ… Notify success
        if: success()
        run: |
          echo "ğŸ‰ Â¡EfemÃ©ride astronÃ³mica generada exitosamente!"
          echo "ğŸŒŸ La nueva efemÃ©ride ya estÃ¡ disponible en la base de datos"
          echo "ï¿½ Revisa tu aplicaciÃ³n web para ver el contenido generado"

      - name: âŒ Notify failure
        if: failure()
        run: |
          echo "ğŸ’¥ Error en la generaciÃ³n de efemÃ©rides"
          echo "ğŸ” Revisa los logs anteriores para identificar el problema"
          echo "ğŸ’¡ Problemas comunes:"
          echo "   â€¢ Variables de entorno no configuradas"
          echo "   â€¢ LÃ­mites de API de OpenAI alcanzados"
          echo "   â€¢ Problemas de conexiÃ³n con Supabase"
          echo "   â€¢ Errores de sintaxis en el cÃ³digo"
          exit 1
